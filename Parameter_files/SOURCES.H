#ifndef _SOURCES_
#define _SOURCES_

// Function definitions for source populations
// This might go somewhere else in the code, but doing it all here for now
// Rick Mebane 2018

#include "INIT_PARAMS.H"
#include "ANAL_PARAMS.H"
#include <math.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

// struct containing function pointers for source populations
/*
typedef struct{
    double (*fesc)(double, double);
    double (*fescIII)(double, double);
    double (*Nion)(double, double);
    double (*NionIII)(double, double);
    double (*fstar)(double, double);
    double (*fstarIII)(double, double);
    double (*minMass)(double);
    double (*minMassIII)(double);
} sources;*/


// more general, allows for halos with multiple populations
typedef struct{
    double (*fesc)(double, double);
    double (*Nion)(double, double);
    double (*fstar)(double, double);
    double (*fx)(double, double);
    double (*minMass)(double);
} sources;

// atomic cooling threshold
// used for min mass comparisons
double minMassATC(double z)
{
    double mu;
    mu = 1.22;
    return (double) TtoM(z, 1.0e4, mu);
}

// initialize source struct
// if not using Pop III stars, make minMassIII(z) = -1
sources setSources(double (*fesc)(double, double),
                   double (*Nion)(double, double),
                   double (*fstar)(double, double),
                   double (*fx)(double, double),
                   double (*minMass)(double))
{
    sources s;
    s.fesc = fesc;
    s.Nion = Nion;
    s.fstar = fstar;
    s.minMass = minMass;
    s.fx = fx;
    return s;
}

double zeta_at_M(sources s, double z, double M)
{
    return 1.22 * s.fstar(z, M) * s.fesc(z, M) * s.Nion(z, M);
}


/*
// initialize source struct
// if not using Pop III stars, make minMassIII(z) = -1
sources setSources(double (*fesc)(double, double),
                   double (*fescIII)(double, double),
                   double (*Nion)(double, double),
                   double (*NionIII)(double, double),
                   double (*fstar)(double, double),
                   double (*fstarIII)(double, double),
                   double (*minMass)(double),
                   double (*minMassIII)(double))
{
    sources s;
    s.fesc = fesc;
    s.fescIII = fescIII;
    s.Nion = Nion;
    s.NionIII = NionIII;
    s.fstar = fstar;
    s.fstarIII = fstarIII;
    s.minMass = minMass;
    s.minMassIII = minMassIII;
    return s;
}*/

// initialize source struct for general case
//sources2 setSources(double ())



// BEGIN SPECIFIC SOURCE FUNCTIONS

double fstar_jordan(double z, double M)
{
    FILE * fp;
    char * line = NULL;
    size_t len = 0;
    ssize_t read = 0;
    double table[26*61];

    const char *s = " ";
    char *token = NULL;

    int i = 0;
    int j;

    fp = fopen("../Parameter_files/smhm_uvlf.txt", "r");
    if(fp == NULL)
    {
        printf("Error opening");
        exit(EXIT_FAILURE);
    }

    while ((read=getline(&line, &len, fp)) != -1)
    {
        token = strtok(line, s);
        while(token != NULL)
        {
            table[i] = atof(token);
            token=strtok(NULL, s);
            i++;
        }
    }

    fclose(fp);

    // get fstar from table
    int zind, Mind;
    zind = (int) round(z-5);
    Mind = (int) round(((log10(M) - 8) / 5) * 50 + 10);
    return table[Mind * 26 + zind] * .28 / .046 * 2.0;

}

// Eq. 1 from Feng & Holder 2018
// Not really a source pop function, but putting it here for now...
// Tcmb given at z=0 
double T_background(double Tcmb, double excess_frac, double z)
{
    double beta, Tr;
    beta = -2.62;
    Tr = 1.19;
    return (Tcmb + excess_frac * Tr * pow(1.428 / (1.0 + z), beta)) * (1.0 + z);
}

double T_background2(double Tcmb, double excess_frac, double z)
{
    FILE * fp;
    char * line = NULL;
    size_t len = 0;
    ssize_t read = 0;
    double table[2*1000];

    const char *s = " ";
    char *token = NULL;
    
    int i = 0;
    int j;

    fp = fopen("../Parameter_files/Trad.txt", "r");
    if(fp == NULL)
    {
        printf("Error opening");
        exit(EXIT_FAILURE);
    }

    while ((read=getline(&line, &len, fp)) != -1)
    {
        token = strtok(line, s);
        while(token != NULL)
        {
            table[i] = atof(token);
            token=strtok(NULL, s);
            i++;
        }
    }

    fclose(fp);

    for(i=0; i<1000 - 1; i++)
    {
        if(z >= table[i*2] && z < table[(i+1)*2]) return table[i*2 + 1];
    }
    printf("FAILED TO FIND BEST T_RAD\n");
    return -1;
}

double T_background1(double Tcmb, double excess_frac, double z)
{
    int i;

    double zs[1000] = {5.0, 5.0139447947, 5.02792199894, 5.04193168806, 5.05597393755, 5.07004882309, 5.08415642053, 5.09829680589, 5.11247005538, 5.12667624538, 5.14091545245, 5.15518775332, 5.16949322491, 5.18383194431, 5.19820398879, 5.21260943581, 5.22704836299, 5.24152084816, 5.25602696929, 5.27056680458, 5.28514043236, 5.29974793119, 5.31438937978, 5.32906485703, 5.34377444204, 5.35851821407, 5.37329625258, 5.38810863721, 5.40295544778, 5.41783676431, 5.43275266699, 5.4477032362, 5.46268855251, 5.47770869668, 5.49276374966, 5.50785379258, 5.52297890675, 5.5381391737, 5.55333467511, 5.56856549288, 5.58383170908, 5.599133406, 5.61447066608, 5.62984357199, 5.64525220657, 5.66069665286, 5.67617699408, 5.69169331367, 5.70724569524, 5.72283422261, 5.73845897977, 5.75412005095, 5.76981752052, 5.7855514731, 5.80132199346, 5.8171291666, 5.83297307771, 5.84885381217, 5.86477145555, 5.88072609365, 5.89671781243, 5.9127466981, 5.92881283701, 5.94491631576, 5.96105722113, 5.97723564009, 5.99345165985, 6.00970536779, 6.02599685149, 6.04232619876, 6.0586934976, 6.0750988362, 6.09154230299, 6.10802398657, 6.12454397577, 6.14110235961, 6.15769922733, 6.17433466836, 6.19100877237, 6.2077216292, 6.22447332892, 6.24126396181, 6.25809361836, 6.27496238926, 6.29187036541, 6.30881763794, 6.32580429818, 6.34283043767, 6.35989614816, 6.37700152162, 6.39414665023, 6.41133162639, 6.42855654272, 6.44582149203, 6.46312656737, 6.480471862, 6.49785746939, 6.51528348323, 6.53274999744, 6.55025710614, 6.56780490368, 6.58539348463, 6.60302294377, 6.6206933761, 6.63840487686, 6.6561575415, 6.67395146568, 6.69178674529, 6.70966347646, 6.72758175552, 6.74554167903, 6.76354334378, 6.78158684679, 6.79967228528, 6.81779975674, 6.83596935883, 6.85418118949, 6.87243534685, 6.8907319293, 6.90907103542, 6.92745276406, 6.94587721427, 6.96434448534, 6.98285467679, 7.00140788839, 7.0200042201, 7.03864377215, 7.05732664499, 7.0760529393, 7.09482275599, 7.11363619623, 7.1324933614, 7.15139435311, 7.17033927323, 7.18932822386, 7.20836130732, 7.22743862619, 7.24656028328, 7.26572638162, 7.28493702452, 7.3041923155, 7.32349235833, 7.34283725701, 7.3622271158, 7.38166203918, 7.40114213191, 7.42066749895, 7.44023824552, 7.45985447711, 7.47951629942, 7.4992238184, 7.51897714027, 7.53877637148, 7.55862161872, 7.57851298894, 7.59845058935, 7.61843452737, 7.63846491072, 7.65854184733, 7.6786654454, 7.69883581338, 7.71905305996, 7.7393172941, 7.75962862501, 7.77998716214, 7.80039301521, 7.82084629418, 7.84134710928, 7.86189557099, 7.88249179005, 7.90313587745, 7.92382794444, 7.94456810254, 7.96535646351, 7.98619313939, 8.00707824246, 8.02801188527, 8.04899418065, 8.07002524166, 8.09110518164, 8.11223411419, 8.13341215318, 8.15463941273, 8.17591600725, 8.1972420514, 8.21861766009, 8.24004294853, 8.26151803218, 8.28304302677, 8.30461804829, 8.32624321303, 8.34791863751, 8.36964443855, 8.39142073322, 8.41324763889, 8.43512527318, 8.45705375399, 8.4790331995, 8.50106372814, 8.52314545866, 8.54527851004, 8.56746300156, 8.58969905278, 8.61198678352, 8.63432631391, 8.65671776432, 8.67916125543, 8.70165690818, 8.72420484381, 8.74680518383, 8.76945805004, 8.7921635645, 8.81492184959, 8.83773302795, 8.86059722251, 8.88351455648, 8.90648515337, 8.92950913697, 8.95258663136, 8.97571776091, 8.99890265026, 9.02214142437, 9.04543420846, 9.06878112807, 9.09218230902, 9.1156378774, 9.13914795964, 9.16271268242, 9.18633217274, 9.21000655788, 9.23373596542, 9.25752052326, 9.28136035955, 9.30525560279, 9.32920638173, 9.35321282546, 9.37727506334, 9.40139322505, 9.42556744056, 9.44979784015, 9.4740845544, 9.49842771419, 9.5228274507, 9.54728389544, 9.57179718019, 9.59636743706, 9.62099479847, 9.64567939712, 9.67042136605, 9.6952208386, 9.7200779484, 9.74499282942, 9.76996561592, 9.79499644248, 9.820085444, 9.84523275569, 9.87043851305, 9.89570285194, 9.92102590849, 9.94640781919, 9.9718487208, 9.99734875044, 10.0229080455, 10.0485267438, 10.0742049833, 10.0999429025, 10.12574064, 10.1515983348, 10.1775161264, 10.2034941543, 10.2295325586, 10.2556314796, 10.281791058, 10.3080114346, 10.334292751, 10.3606351485, 10.3870387693, 10.4135037556, 10.4400302501, 10.4666183956, 10.4932683355, 10.5199802134, 10.5467541732, 10.5735903592, 10.6004889162, 10.6274499889, 10.6544737227, 10.6815602632, 10.7087097565, 10.7359223488, 10.7631981867, 10.7905374174, 10.817940188, 10.8454066462, 10.8729369402, 10.9005312182, 10.928189629, 10.9559123216, 10.9836994453, 11.0115511501, 11.0394675859, 11.0674489032, 11.0954952527, 11.1236067857, 11.1517836537, 11.1800260084, 11.2083340021, 11.2367077873, 11.2651475169, 11.2936533442, 11.3222254229, 11.3508639069, 11.3795689504, 11.4083407083, 11.4371793356, 11.4660849877, 11.4950578203, 11.5240979897, 11.5532056522, 11.5823809648, 11.6116240847, 11.6409351695, 11.6703143771, 11.6997618659, 11.7292777945, 11.7588623221, 11.788515608, 11.8182378121, 11.8480290946, 11.8778896159, 11.907819537, 11.9378190193, 11.9678882243, 11.9980273141, 12.0282364511, 12.0585157982, 12.0888655185, 12.1192857756, 12.1497767334, 12.1803385562, 12.2109714087, 12.2416754561, 12.2724508637, 12.3032977974, 12.3342164235, 12.3652069086, 12.3962694196, 12.4274041241, 12.4586111897, 12.4898907847, 12.5212430776, 12.5526682374, 12.5841664334, 12.6157378354, 12.6473826136, 12.6791009383, 12.7108929807, 12.742758912, 12.7746989039, 12.8067131286, 12.8388017586, 12.8709649669, 12.9032029266, 12.9355158117, 12.9679037962, 13.0003670547, 13.032905762, 13.0655200937, 13.0982102253, 13.1309763332, 13.1638185938, 13.1967371842, 13.2297322818, 13.2628040643, 13.2959527101, 13.3291783977, 13.3624813061, 13.395861615, 13.4293195041, 13.4628551538, 13.4964687448, 13.5301604582, 13.5639304756, 13.597778979, 13.6317061508, 13.6657121739, 13.6997972314, 13.7339615071, 13.7682051852, 13.8025284501, 13.8369314868, 13.8714144807, 13.9059776177, 13.9406210839, 13.9753450662, 14.0101497516, 14.0450353277, 14.0800019825, 14.1150499045, 14.1501792824, 14.1853903057, 14.2206831641, 14.2560580477, 14.2915151472, 14.3270546538, 14.3626767589, 14.3983816544, 14.4341695329, 14.4700405871, 14.5059950105, 14.5420329966, 14.5781547398, 14.6143604348, 14.6506502765, 14.6870244607, 14.7234831833, 14.7600266407, 14.7966550301, 14.8333685486, 14.8701673942, 14.9070517652, 14.9440218604, 14.981077879, 15.0182200207, 15.0554484856, 15.0927634744, 15.1301651882, 15.1676538285, 15.2052295974, 15.2428926974, 15.2806433314, 15.3184817028, 15.3564080157, 15.3944224743, 15.4325252835, 15.4707166488, 15.5089967758, 15.5473658709, 15.5858241409, 15.624371793, 15.6630090349, 15.7017360749, 15.7405531217, 15.7794603844, 15.8184580728, 15.8575463969, 15.8967255675, 15.9359957957, 15.9753572931, 16.0148102718, 16.0543549445, 16.0939915242, 16.1337202246, 16.1735412597, 16.2134548442, 16.2534611932, 16.2935605222, 16.3337530474, 16.3740389853, 16.4144185531, 16.4548919683, 16.4954594492, 16.5361212142, 16.5768774825, 16.6177284738, 16.6586744083, 16.6997155065, 16.7408519896, 16.7820840794, 16.823411998, 16.8648359682, 16.9063562132, 16.9479729567, 16.989686423, 17.031496837, 17.0734044239, 17.1154094096, 17.1575120205, 17.1997124833, 17.2420110257, 17.2844078754, 17.3269032611, 17.3694974117, 17.4121905567, 17.4549829262, 17.4978747509, 17.5408662618, 17.5839576907, 17.6271492698, 17.6704412319, 17.7138338102, 17.7573272386, 17.8009217515, 17.8446175838, 17.8884149711, 17.9323141492, 17.9763153549, 18.0204188251, 18.0646247977, 18.1089335108, 18.1533452033, 18.1978601144, 18.242478484, 18.2872005527, 18.3320265613, 18.3769567516, 18.4219913655, 18.4671306459, 18.5123748359, 18.5577241794, 18.6031789208, 18.6487393051, 18.6944055777, 18.7401779848, 18.786056773, 18.8320421895, 18.8781344823, 18.9243338997, 18.9706406907, 19.0170551047, 19.063577392, 19.1102078033, 19.1569465898, 19.2037940035, 19.2507502967, 19.2978157226, 19.3449905347, 19.3922749874, 19.4396693354, 19.4871738342, 19.5347887397, 19.5825143085, 19.6303507979, 19.6782984657, 19.7263575701, 19.7745283703, 19.8228111258, 19.8712060968, 19.9197135442, 19.9683337292, 20.0170669141, 20.0659133613, 20.1148733341, 20.1639470964, 20.2131349126, 20.2624370478, 20.3118537677, 20.3613853385, 20.4110320274, 20.4607941017, 20.5106718296, 20.56066548, 20.6107753223, 20.6610016265, 20.7113446633, 20.7618047039, 20.8123820204, 20.8630768852, 20.9138895716, 20.9648203535, 21.0158695052, 21.0670373019, 21.1183240194, 21.1697299339, 21.2212553227, 21.2729004632, 21.3246656339, 21.3765511138, 21.4285571823, 21.4806841198, 21.5329322073, 21.5853017262, 21.6377929588, 21.690406188, 21.7431416973, 21.7959997709, 21.8489806937, 21.9020847512, 21.9553122295, 22.0086634155, 22.0621385968, 22.1157380615, 22.1694620984, 22.2233109971, 22.2772850477, 22.3313845412, 22.3856097691, 22.4399610236, 22.4944385977, 22.5490427848, 22.6037738793, 22.6586321761, 22.7136179708, 22.7687315598, 22.8239732401, 22.8793433094, 22.934842066, 22.9904698092, 23.0462268385, 23.1021134546, 23.1581299586, 23.2142766523, 23.2705538384, 23.3269618202, 23.3835009015, 23.4401713872, 23.4969735826, 23.5539077938, 23.6109743276, 23.6681734917, 23.7255055942, 23.782970944, 23.840569851, 23.8983026254, 23.9561695785, 24.014171022, 24.0723072686, 24.1305786315, 24.1889854247, 24.2475279631, 24.3062065621, 24.365021538, 24.4239732076, 24.4830618887, 24.5422878998, 24.6016515599, 24.661153189, 24.7207931079, 24.7805716377, 24.8404891008, 24.9005458201, 24.9607421191, 25.0210783222, 25.0815547547, 25.1421717424, 25.2029296121, 25.2638286911, 25.3248693076, 25.3860517905, 25.4473764697, 25.5088436756, 25.5704537393, 25.6322069931, 25.6941037695, 25.7561444023, 25.8183292257, 25.8806585749, 25.9431327858, 26.0057521949, 26.0685171399, 26.131427959, 26.1944849911, 26.2576885761, 26.3210390546, 26.384536768, 26.4481820585, 26.5119752691, 26.5759167436, 26.6400068265, 26.7042458633, 26.7686342001, 26.8331721839, 26.8978601625, 26.9626984846, 27.0276874995, 27.0928275575, 27.1581190096, 27.2235622077, 27.2891575045, 27.3549052534, 27.4208058088, 27.4868595258, 27.5530667604, 27.6194278694, 27.6859432104, 27.7526131418, 27.819438023, 27.8864182141, 27.953554076, 28.0208459705, 28.0882942604, 28.155899309, 28.2236614806, 28.2915811406, 28.3596586548, 28.4278943901, 28.4962887144, 28.5648419961, 28.6335546048, 28.7024269106, 28.7714592848, 28.8406520994, 28.9100057273, 28.9795205421, 29.0491969186, 29.1190352323, 29.1890358594, 29.2591991772, 29.3295255639, 29.4000153985, 29.4706690607, 29.5414869314, 29.6124693922, 29.6836168257, 29.7549296152, 29.8264081451, 29.8980528006, 29.9698639677, 30.0418420335, 30.1139873859, 30.1863004136, 30.2587815063, 30.3314310548, 30.4042494504, 30.4772370855, 30.5503943537, 30.623721649, 30.6972193666, 30.7708879027, 30.8447276542, 30.9187390191, 30.9929223962, 31.0672781853, 31.1418067871, 31.2165086032, 31.2913840362, 31.3664334897, 31.441657368, 31.5170560766, 31.5926300218, 31.6683796109, 31.744305252, 31.8204073543, 31.8966863281, 31.9731425842, 32.0497765349, 32.1265885929, 32.2035791724, 32.2807486882, 32.3580975562, 32.4356261931, 32.5133350169, 32.5912244463, 32.6692949011, 32.7475468019, 32.8259805705, 32.9045966296, 32.9833954028, 33.0623773148, 33.1415427912, 33.2208922586, 33.3004261448, 33.3801448782, 33.4600488885, 33.5401386064, 33.6204144633, 33.7008768919, 33.7815263259, 33.8623631999, 33.9433879495, 34.0246010113, 34.106002823, 34.1875938234, 34.269374452, 34.3513451496, 34.433506358, 34.5158585199, 34.5984020791, 34.6811374806, 34.76406517, 34.8471855944, 34.9304992016, 35.0140064407, 35.0977077617, 35.1816036157, 35.2656944547, 35.349980732, 35.4344629017, 35.5191414192, 35.6040167408, 35.6890893239, 35.7743596269, 35.8598281094, 35.945495232, 36.0313614563, 36.1174272451, 36.2036930622, 36.2901593725, 36.3768266419, 36.4636953376, 36.5507659276, 36.6380388812, 36.7255146687, 36.8131937615, 36.9010766321, 36.9891637542, 37.0774556024, 37.1659526525, 37.2546553815, 37.3435642674, 37.4326797894, 37.5220024276, 37.6115326634, 37.7012709794, 37.7912178591, 37.8813737873, 37.9717392498, 38.0623147336, 38.1531007268, 38.2440977187, 38.3353061996, 38.4267266611, 38.5183595959, 38.6102054978, 38.7022648617, 38.7945381838, 38.8870259613, 38.9797286926, 39.0726468774, 39.1657810163, 39.2591316113, 39.3526991655, 39.446484183, 39.5404871694, 39.6347086311, 39.729149076, 39.823809013, 39.9186889522, 40.013789405, 40.1091108838, 40.2046539024, 40.3004189756, 40.3964066195, 40.4926173514, 40.5890516898, 40.6857101544, 40.782593266, 40.8797015468, 40.9770355201, 41.0745957105, 41.1723826437, 41.2703968467, 41.3686388476, 41.467109176, 41.5658083624, 41.6647369389, 41.7638954384, 41.8632843955, 41.9629043456, 42.0627558257, 42.1628393739, 42.2631555295, 42.3637048331, 42.4644878266, 42.5655050532, 42.6667570571, 42.7682443842, 42.8699675812, 42.9719271964, 43.0741237792, 43.1765578805, 43.2792300521, 43.3821408475, 43.4852908212, 43.5886805291, 43.6923105284, 43.7961813776, 43.9002936363, 44.0046478657, 44.1092446282, 44.2140844874, 44.3191680083, 44.4244957572, 44.5300683018, 44.635886211, 44.741950055, 44.8482604054, 44.9548178351, 45.0616229185, 45.168676231, 45.2759783495, 45.3835298524, 45.4913313193, 45.599383331, 45.7076864699, 45.8162413196, 45.9250484652, 46.0341084931, 46.1434219908, 46.2529895476, 46.362811754, 46.4728892017, 46.5832224839, 46.6938121953, 46.8046589319, 46.9157632909, 47.0271258712, 47.1387472729, 47.2506280975, 47.362768948, 47.4751704286, 47.5878331452, 47.7007577048, 47.8139447161, 47.927394789, 48.0411085349, 48.1550865666, 48.2693294983, 48.3838379457, 48.498612526, 48.6136538575, 48.7289625604, 48.8445392559, 48.960384567, 49.076499118, 49.1928835345, 49.3095384439, 49.4264644747, 49.5436622571, 49.6611324226, 49.7788756044, 49.8968924369, 50.0151835562, 50.1337495997, 50.2525912064, 50.3717090167, 50.4911036726, 50.6107758175, 50.7307260963, 50.8509551555, 50.9714636429, 51.0922522079, 51.2133215016, 51.3346721764, 51.4563048863, 51.5782202866, 51.7004190345, 51.8229017885, 51.9456692086, 52.0687219564, 52.1920606952, 52.3156860895, 52.4395988056, 52.5637995112, 52.6882888758, 52.8130675701, 52.9381362666, 53.0634956394, 53.1891463639, 53.3150891173, 53.4413245784, 53.5678534275, 53.6946763463, 53.8217940184, 53.9492071288, 54.0769163642, 54.2049224127, 54.3332259642, 54.4618277102, 54.5907283437, 54.7199285593, 54.8494290533, 54.9792305236, 55.1093336698, 55.2397391929, 55.3704477957, 55.5014601826, 55.6327770596, 55.7643991345, 55.8963271164, 56.0285617165, 56.1611036474, 56.2939536232, 56.4271123599, 56.5605805752, 56.6943589883, 56.8284483202, 56.9628492934, 57.0975626323, 57.2325890629, 57.3679293127, 57.5035841112, 57.6395541894, 57.7758402801, 57.9124431178, 58.0493634385, 58.1866019801, 58.3241594824, 58.4620366864, 58.6002343354, 58.738753174, 58.8775939487, 59.0167574078, 59.1562443012, 59.2960553806, 59.4361913995, 59.576653113, 59.7174412782, 59.8585566537, 60.0};
    double Ts[1000] = {27.7160202716, 27.9551071591, 28.1962564834, 28.4394860357, 28.6848137606, 28.9322577578, 29.1818362827, 29.4335677485, 29.6874707271, 29.9435639506, 30.2018663127, 30.4623968703, 30.7251748442, 30.9902196216, 31.2575507564, 31.5271879716, 31.7991511601, 32.0734603863, 32.3501358881, 32.6291980776, 32.910667543, 33.1945650504, 33.4809115446, 33.7697281516, 34.0610361791, 34.3548571189, 34.6512126483, 34.9501246313, 35.2516151207, 35.5557063595, 35.8624207826, 36.1717810183, 36.4838098902, 36.7985304188, 37.1159658232, 37.4361395227, 37.7590751386, 38.0847964962, 38.4133276261, 38.7446927663, 39.0789163637, 39.4160230763, 39.7560377748, 40.0989855443, 40.4448916863, 40.7937817208, 41.1456813877, 41.5006166491, 41.8586136907, 42.2196989246, 42.5838989905, 42.9512407577, 43.3217513277, 43.6954580354, 44.0723884517, 44.4525703854, 44.8360318849, 45.222801241, 45.612906988, 46.0063779068, 46.4032430264, 46.8035316262, 47.2072732381, 47.614497649, 48.0252349024, 48.4395153013, 48.85736941, 49.2788280563, 49.7039223341, 50.1326836054, 50.5651435029, 51.001333932, 51.4412870736, 51.8850353857, 52.3326116069, 52.7840487578, 53.2393801439, 53.6986393581, 54.1618602831, 54.6290770938, 55.10032426, 55.5756365486, 56.0550490268, 56.538597064, 57.0263163348, 57.5182428216, 58.014412817, 58.5148629269, 59.0196300729, 59.528751495, 60.0422647546, 60.5602077369, 61.0826186543, 61.6095360483, 62.1409987934, 62.677046099, 63.2177175129, 63.7630529243, 64.3130925661, 64.8678770184, 65.4274472115, 65.9918444287, 66.5611103092, 67.1352868518, 67.7144164172, 68.2985417318, 68.8877058905, 69.4819523598, 70.0813249813, 70.6858679748, 71.2956259414, 71.9106438673, 72.5309671263, 73.1566414838, 73.7877131002, 74.4242285339, 75.0662347448, 75.713779098, 76.3669093674, 77.0256737387, 77.6901208135, 78.3602996124, 79.036259579, 79.7180505836, 80.4057229264, 81.0993273416, 81.7989150011, 82.5045375182, 83.2162469515, 83.9340958086, 84.6581370499, 85.388424093, 86.125010816, 86.8679515619, 87.6173011423, 88.373114842, 89.1354484224, 89.9043581259, 90.6799006803, 91.4621333025, 92.2511137031, 93.0469000904, 93.8495511752, 94.6591261742, 95.4756848154, 96.2992873417, 97.1299945159, 97.9678676249, 98.8129684841, 99.6653594424, 100.525103386, 101.392263745, 102.266904495, 103.149090165, 104.038885838, 104.936357161, 105.841570348, 106.75459218, 107.675490019, 108.604331805, 109.541186065, 110.486121917, 111.439209076, 112.400517856, 113.370119181, 114.348084584, 115.334486216, 116.329396851, 117.33288989, 118.345039368, 119.365919958, 120.395606976, 121.43417639, 122.481704823, 123.538269557, 124.603948542, 125.678820401, 126.762964434, 127.856460626, 128.959389651, 130.07183288, 131.193872385, 132.325590947, 133.467072061, 134.61839994, 135.779659527, 136.950936494, 138.132317257, 139.323888971, 140.525739549, 141.737957658, 142.960632732, 144.193854976, 145.437715373, 146.692305691, 147.95771849, 149.234047128, 150.521385768, 151.819829386, 153.129473776, 154.45041556, 155.782752193, 157.126581971, 158.482004036, 159.849118387, 161.228025885, 162.618828263, 164.021628128, 165.436528975, 166.86363519, 168.303052061, 169.754885784, 171.219243468, 172.696233152, 174.185963801, 175.688545323, 177.204088574, 178.732705366, 180.274508475, 181.82961165, 183.398129622, 184.980178111, 186.575873835, 188.18533452, 189.808678906, 191.446026758, 193.097498875, 194.763217096, 196.443304313, 198.137884478, 199.847082611, 201.571024811, 203.309838265, 205.063651257, 206.832593177, 208.616794532, 210.416386956, 212.231503215, 214.062277224, 215.90884405, 217.771339928, 219.649902266, 221.54466966, 223.455781897, 225.383379974, 227.327606104, 229.288603724, 231.26651751, 233.261493388, 235.273678539, 237.303221415, 239.350271751, 241.414980571, 243.497500201, 245.597984285, 247.716587788, 249.853467015, 252.008779616, 254.182684605, 256.375342365, 258.586914663, 260.817564662, 263.067456931, 265.336757461, 267.625633672, 269.934254432, 272.262790062, 274.611412354, 276.980294582, 279.369611515, 281.779539427, 284.210256117, 286.661940914, 289.134774696, 291.6289399, 294.144620537, 296.682002207, 299.24127211, 301.822619058, 304.426233497, 307.052307513, 309.701034848, 312.372610916, 315.067232819, 317.785099357, 320.526411045, 323.291370127, 326.080180594, 328.893048196, 331.730180455, 334.591786687, 337.478078012, 340.38926737, 343.325569541, 346.287201154, 349.274380709, 352.287328591, 355.326267085, 358.391420394, 361.483014655, 364.601277956, 367.746440352, 370.918733883, 374.118392591, 377.345652536, 380.600751814, 383.883930576, 387.195431045, 390.535497532, 393.904376457, 397.302316364, 400.729567942, 404.186384043, 407.6730197, 411.189732144, 414.736780829, 418.314427442, 421.922935932, 425.562572522, 429.233605734, 432.936306403, 436.670947704, 440.437805165, 444.237156693, 448.069282592, 451.934465585, 455.83299083, 459.76514595, 463.731221045, 467.731508719, 471.766304102, 475.835904866, 479.940611254, 484.080726098, 488.256554841, 492.468405564, 496.716589002, 501.001418572, 505.323210396, 509.682283321, 514.078958946, 518.513561642, 522.986418581, 527.497859755, 532.048218003, 536.637829037, 541.267031463, 545.936166807, 550.645579545, 555.39561712, 560.186629976, 565.018971578, 569.892998439, 574.809070151, 579.767549404, 584.768802019, 589.813196972, 594.901106423, 600.032905741, 605.208973532, 610.429691671, 615.695445326, 621.006622985, 626.363616491, 631.766821066, 637.216635339, 642.713461381, 648.25770473, 653.849774422, 659.49008302, 665.17904665, 670.917085025, 676.704621477, 682.542082993, 688.429900242, 694.368507607, 700.35834322, 706.399848991, 712.493470643, 718.639657743, 724.838863738, 731.091545984, 737.398165783, 743.759188419, 750.175083186, 756.646323428, 763.173386572, 769.756754163, 776.396911902, 783.094349677, 789.849561603, 796.663046059, 803.53530572, 810.4668476, 817.458183084, 824.509827972, 831.622302511, 838.796131435, 846.031844007, 853.329974054, 860.691060008, 868.115644945, 875.604276629, 883.157507545, 890.775894947, 898.460000894, 906.210392294, 914.027640947, 921.912323583, 929.865021908, 937.886322648, 945.976817586, 954.137103614, 962.367782771, 970.669462289, 979.04275464, 987.488277578, 996.006654186, 1004.59851292, 1013.26448766, 1022.00521776, 1030.82134808, 1039.71352904, 1048.68241667, 1057.72867268, 1066.85296447, 1076.0559652, 1085.33835383, 1094.70081519, 1104.14404002, 1113.668725, 1123.27557282, 1132.96529227, 1142.7385982, 1152.59621167, 1162.53885993, 1172.56727653, 1182.68220132, 1192.88438055, 1203.17456691, 1213.55351957, 1224.02200426, 1234.5807933, 1245.2306657, 1255.97240716, 1266.80681018, 1277.73467408, 1288.75680508, 1299.87401636, 1311.08712812, 1322.39696761, 1333.80436925, 1345.31017463, 1356.91523262, 1349.97805142, 1324.41001143, 1299.21813617, 1274.35454971, 1249.75857019, 1225.5045474, 1201.64358313, 1178.14242013, 1154.97797126, 1132.13515246, 1109.57356585, 1087.31572784, 1065.42362051, 1043.9071858, 1022.72485657, 1001.83679497, 981.217096195, 960.885161627, 940.880134069, 921.216576463, 901.90564366, 882.93230249, 864.238174308, 845.795347163, 827.643222284, 809.799272805, 792.256774808, 775.031830193, 758.117468565, 741.481829073, 725.077700643, 708.931821138, 693.078448641, 677.523315603, 662.265587545, 647.257767945, 632.474877207, 617.926587371, 603.661785894, 589.685471705, 575.96408368, 562.50613384, 549.294279347, 536.296219512, 523.524664955, 510.999279031, 498.730231396, 486.711992296, 474.940984478, 463.38003586, 452.001434571, 440.845061835, 429.927493264, 419.238546648, 408.77236824, 398.52934573, 388.466981477, 378.579422206, 368.901074384, 359.438439411, 350.182829385, 341.126001608, 332.260389993, 323.562063798, 315.033943788, 306.694369788, 298.550410727, 290.590358634, 282.810675663, 275.185741509, 267.709410453, 260.407789537, 253.277991162, 246.317297201, 239.523042107, 232.871440112, 226.352566946, 219.985424831, 213.774846247, 207.718160139, 201.808862131, 196.044478089, 190.415988484, 184.90675675, 179.526273788, 174.282208923, 169.170706152, 164.19345955, 159.339952072, 154.590579483, 149.953924281, 145.440771193, 141.045831162, 136.769901113, 132.606423566, 128.550675205, 124.589999477, 120.723040694, 116.965338279, 113.31272628, 109.756506728, 106.296021179, 102.921480284, 99.6331410363, 96.437317424, 93.3318798774, 90.3151487122, 87.3862689302, 84.5401929264, 81.7634357523, 79.0580005828, 76.4337938763, 73.8893945936, 71.4211629206, 69.0271037024, 66.6995645236, 64.432751954, 62.2296375556, 60.0936961228, 58.0262752532, 56.0241318695, 54.0828495993, 52.1948656172, 50.3586566524, 48.5788716547, 46.8563425965, 45.189955822, 43.5778778522, 42.0156102903, 40.4970314805, 39.0247189721, 37.6007205401, 36.2227576201, 34.8911024378, 33.6049088853, 32.3561483252, 31.1448736472, 29.9754416535, 28.8451713474, 27.7535809293, 26.6998613936, 25.6798977721, 24.6912277176, 23.7355211814, 22.8142913377, 21.9254751101, 21.0680355331, 20.2421208044, 19.4442486039, 18.6715579916, 17.92540876, 17.2066221112, 16.5144021763, 15.8476052229, 15.2048975532, 14.5841428446, 13.9844168035, 13.4072705709, 12.8514043654, 12.316750929, 11.80325227, 11.3089723897, 10.8317161724, 10.37153666, 9.92943983981, 9.50484229943, 9.09713470128, 8.70570705812, 8.32921170453, 7.96595286146, 7.61653046081, 7.28129879788, 6.95981597532, 6.65162230871, 6.35511881982, 6.06973526545, 5.79588136906, 5.53354045785, 5.28198859732, 5.04114483924, 4.81075838843, 4.58915787031, 4.37593256921, 4.17189806332, 3.97678505714, 3.79019615148, 3.61188933725, 3.44141626716, 3.27804328679, 3.12126401472, 2.97108009173, 2.8275587208, 2.69065122858, 2.56009848736, 2.43539632653, 2.31580995745, 2.20126423936, 2.09198783622, 1.98784198738, 1.88853581425, 1.79389039753, 1.70332158214, 1.61662134644, 1.53407733562, 1.45557058111, 1.38079399219, 1.30954063841, 1.24185379331, 1.1772091618, 1.11542157837, 1.05666587531, 1.00085117173, 0.94781860518, 0.89740610047, 0.849344596894, 0.803539714154, 0.760038927042, 0.718710422644, 0.679541131362, 0.64240668729, 0.607172262033, 0.573590392249, 0.541621978045, 0.511379407741, 0.482698478762, 0.455523280586, 0.429823875393, 0.405502795577, 0.382392386583, 0.360427972137, 0.339642121307, 0.31998421452, 0.301422766157, 0.283900649645, 0.267287564193, 0.251528338149, 0.236631610192, 0.222563732102, 0.209293587668, 0.196777909668, 0.184972527633, 0.173791214648, 0.163200830442, 0.153225488917, 0.143836159639, 0.134993147982, 0.126669752826, 0.118807200973, 0.111373269602, 0.104375835046, 0.0977966500446, 0.0916134082448, 0.0858040838535, 0.0803481345009, 0.0752061711877, 0.0703509184638, 0.0657916414812, 0.0615194587564, 0.0575115718031, 0.0537505937881, 0.0502201990439, 0.0468972045928, 0.0437733622409, 0.0408490257136, 0.0381130643164, 0.0355535651814, 0.033158165434, 0.0309068704257, 0.0287939850195, 0.0268184346716, 0.0249717917782, 0.0232480667612, 0.0216380730223, 0.0201342650883, 0.0187257278289, 0.0174044212655, 0.0161725367122, 0.0150249733602, 0.0139547568116, 0.0129586360012, 0.0120300271328, 0.0111608339131, 0.0103491529919, 0.00959363865594, 0.00889179168682, 0.0082390753527, 0.00763212510475, 0.00706687239045, 0.00653904708298, 0.00604863222141, 0.00559410567213, 0.00517254816998, 0.00478146740128, 0.00441880885166, 0.00408116988033, 0.00376681516879, 0.00347577370098, 0.00320670100394, 0.00295768749523, 0.00272727155853, 0.0025135498533, 0.00231495761447, 0.00213125774944, 0.00196157260007, 0.00180487880113, 0.00166027592028, 0.00152698029243, 0.00140348206209, 0.00128895253159, 0.00118352218983, 0.00108643223994, 0.00099704467449, 0.000914779453986, 0.000839145947237, 0.000769282836528, 0.000704610924749, 0.000645300528635, 0.000590838402309, 0.000540747669117, 0.000494795613497, 0.000452527537474, 0.000413577338946, 0.00037775705707, 0.000344942052371, 0.000314917774545, 0.000287396541094, 0.000262215777232, 0.000239078288074, 0.000217843699309, 0.000198449452646, 0.000180699458877, 0.000164487654239, 0.000149709087234, 0.000136187819793, 0.000123777503994, 0.000112440717712, 0.000102119053538, 9.27208251634e-05, 8.41617418016e-05, 7.63677530972e-05, 6.92445286615e-05, 6.27305200659e-05, 5.68078247204e-05, 5.1433512262e-05, 4.65536163956e-05, 4.21255097475e-05, 3.81081733254e-05, 3.44452811931e-05, 3.11092928089e-05, 2.80906808342e-05, 2.53553548719e-05, 2.28772635747e-05, 2.06379170924e-05, 1.86020495124e-05, 1.67510450157e-05, 1.50811123569e-05, 1.35721692648e-05, 1.22092102699e-05, 1.09813555412e-05, 9.87374153336e-06, 8.87019052529e-06, 7.962626316e-06, 7.14515468096e-06, 6.4091300787e-06, 5.74683650613e-06, 5.15114549667e-06, 4.61554017154e-06, 4.13195182712e-06, 3.69647194238e-06, 3.30571495648e-06, 2.95516482203e-06, 2.64089455962e-06, 2.35925905975e-06, 2.10586622979e-06, 1.87782414339e-06, 1.67385474757e-06, 1.49147980065e-06, 1.3285466349e-06, 1.18301021062e-06, 1.0533216477e-06, 9.36894251503e-07, 8.32371979339e-07, 7.39259173889e-07, 6.56276896898e-07, 5.82509599376e-07, 5.16887569887e-07, 4.58300558508e-07, 4.05975954084e-07, 3.59372104794e-07, 3.1797580963e-07, 2.81259592767e-07, 2.48711977242e-07, 2.1986048988e-07, 1.94177044851e-07, 1.7132845134e-07, 1.51100350751e-07, 1.33192172588e-07, 1.17361745839e-07, 1.03387092786e-07, 9.10216494929e-08, 8.00553456754e-08, 7.03473665787e-08, 6.17895614511e-08, 5.42570682059e-08, 4.76272525112e-08, 4.17861731634e-08, 3.66354349149e-08, 3.20897694574e-08, 2.80861778091e-08, 2.45727759354e-08, 2.14877203436e-08, 1.87860552005e-08, 1.64178448906e-08, 1.43276492488e-08, 1.24900178159e-08, 1.0884832716e-08, 9.48246054991e-09, 8.25816523277e-09, 7.18908292054e-09, 6.2539024276e-09, 5.43412255829e-09, 4.71783204216e-09, 4.09470454953e-09, 3.55240439766e-09, 3.07951898434e-09, 2.66869747823e-09, 2.31056004582e-09, 1.99829308069e-09, 1.72736298237e-09, 1.49227871063e-09, 1.28855277313e-09, 1.1123208471e-09, 9.59615347815e-10, 8.26750888977e-10, 7.11521287802e-10, 6.12156149147e-10, 5.26532994687e-10, 4.52674691189e-10, 3.89015010341e-10, 3.33968014883e-10, 2.86374507526e-10, 2.45383509105e-10, 2.10118041466e-10, 1.79856984918e-10, 1.53880603144e-10, 1.31553046369e-10, 1.12346344201e-10, 9.58483910047e-11, 8.17551821527e-11, 6.96819776828e-11, 5.93493427681e-11, 5.05321988012e-11, 4.3001652118e-11, 3.65460054356e-11, 3.10186161279e-11, 2.63212512438e-11, 2.2324991139e-11, 1.89239734546e-11, 1.60326838965e-11, 1.35659130409e-11, 1.14619625522e-11, 9.67999369873e-12, 8.17155877941e-12, 6.89423703628e-12, 5.81321155308e-12, 4.8981963399e-12, 4.12178149175e-12, 3.4648567639e-12, 2.91144640373e-12, 2.44451680542e-12, 2.05121106809e-12, 1.72047569952e-12, 1.44124276722e-12, 1.20572999267e-12, 1.00807435297e-12, 8.42343113448e-13, 7.03549697183e-13, 5.87224716925e-13, 4.89887336917e-13, 4.08137735173e-13, 3.3946246701e-13, 2.82125912725e-13, 2.34392256393e-13, 1.94720804198e-13, 1.61606693732e-13, 1.33997785943e-13, 1.10981200618e-13, 9.17926953874e-14, 7.5873994775e-14, 6.26594871387e-14, 5.17079699087e-14, 4.26542234483e-14, 3.51530071614e-14, 2.89337848876e-14, 2.37925153649e-14, 1.95474835356e-14, 1.60486497954e-14, 1.31709651854e-14, 1.08044233557e-14, 8.84952100702e-15, 7.23448764008e-15, 5.91185234057e-15, 4.82770249738e-15, 3.93987414904e-15, 3.21333360421e-15, 2.61721742494e-15, 2.12812446411e-15, 1.72973106784e-15, 1.40526017253e-15, 1.14042942177e-15, 9.24686795613e-16, 7.49373070392e-16, 6.06397498752e-16, 4.89599738046e-16, 3.95063154089e-16, 3.18735926348e-16, 2.56896140786e-16, 2.06871002329e-16, 1.66527277365e-16, 1.33798968662e-16, 1.07281613882e-16, 8.59560894235e-17, 6.88262317228e-17, 5.50386606528e-17, 4.39859617951e-17, 3.51050556734e-17, 2.7943642325e-17, 2.21991130992e-17, 1.76073350448e-17, 1.39406882003e-17, 1.10158274009e-17, 8.68737089223e-18, 6.8223372008e-18, 5.33205133119e-18, 4.14785942022e-18, 3.20925312334e-18, 2.46495236308e-18, 1.87327853347e-18, 1.40321053083e-18, 1.03032905603e-18, 7.34216048427e-19, 4.99462478873e-19, 3.13859506767e-19, 1.67177515601e-19, 5.13388755182e-20, 0.0};

    for(i=0; i<1000 - 1; i++)
    {
        if(z >= zs[i] && z < zs[i+1]) return Ts[i] * 1.2;
    }
    printf("FAILES TO FIND BEST T_RAD\n");
    return -1;
}

double Mmin_jordan(double z)
{
    FILE * fp;
    char * line = NULL;
    size_t len = 0;
    ssize_t read = 0;
    double table[26*61];

    const char *s = " ";
    char *token = NULL;

    int i = 0;
    int j;

    fp = fopen("../Parameter_files/smhm_uvlf.txt", "r");
    if(fp == NULL)
    {
        printf("Error opening");
        exit(EXIT_FAILURE);
    }

    while ((read=getline(&line, &len, fp)) != -1)
    {
        token = strtok(line, s);
        while(token != NULL)
        {
            table[i] = atof(token);
            token=strtok(NULL, s);
            i++;
        }
    }

    fclose(fp);

    double logM = 7;
    int zind, Mind;
    while(logM < 10)
    {
        Mind = (int) round(((logM - 8) / 5) * 50 + 10);
        zind = (int) round(z-5);

        if(table[Mind * 26 + zind] > 0) 
        {
            return pow(10.0, logM);
        }
        logM += 0.1;
    }
    return 1.0e8;
    
}

double fstar_21cmfid(double z, double M)
{
    return 2.5e-2 * pow(M / 1.0e10, 0.4);
}

double fesc_21cmfid(double z, double M)
{
    return 0.1 * pow(M / 1.0e10, -0.4);
}

//double fescDef(double z, double M) {return 0.1;}//{return 0.1 * pow(M / 1.0e10, -0.4);}
//double fescIIIDef(double z, double M) {return 0.5;}//{return 1.0;}
//double NionDef(double z, double M) {return 5000.0;}
//double NionIIIDef(double z, double M) {return 40000.0;}
//double fstarDef(double z, double M) {return 0.03 * pow(M / 1.0e10, 0.4);}
//double fstarIIIDef(double z, double M) {return 0.0005;}//{return 1.0e-4;}
//double minMassIIIDef(double z) {return -1;}//{return minMassATC(z) / 10.0;}
//double minMassDef(double z) {return 1.0e8;}//{return minMassATC(z);}//{return 1.0e8;}
double fxDef(double z, double M)
{
    if(M > minMassATC(z)) return 1.0;
    return 100.0;
}

double minMassDef(double z)
{
    //return 1.0e4;
    return pow(10.0, -3.0/44.0 * z + 8.4); // linear fit to fiducial min mass in log space
}

double NionDef(double z, double M)
{
    if(M > minMassATC(z)) return 5000.0;
    return 40000.0;
}

double fstarDef(double z, double M)
{
    if(M > minMassATC(z)) return 0.03 * pow(M / 1.0e10, 0.4);
    return 0.0005;
}

double fstarTest(double z, double M)
{
    if(M > 1.0e8) return 0.05;
    return 0.005;
}

double fescDef(double z, double M)
{
    if(M > minMassATC(z)) return 0.1;
    return 1.0;
}

double etaSteveEnergy(double z, double M)
{
    return pow(pow(10, 11.5) / M, 2.0/3.0) * 9.0 / (1.0 + z);
}

double fstarSteveEnergy(double z, double M)
{
    return 1.0 / (1.0 + etaSteveEnergy(z, M));
}

double etaSteveMom(double z, double M)
{
    return 0.2 * pow(pow(10, 11.5) / M, 1.0/3.0) * pow(9.0 / (1.0 + z), 1.0/2.0);
}

double fstarSteveMom(double z, double M)
{
    return 1.0 / (1.0 + etaSteveMom(z, M));
}

double minMassCutoff(double z) {return 1e7;}
double NionCutoff(double z, double M) {return 5000;}
double fescCutoff(double z, double M) {return 0.1;}
double fstarCutoff(double z, double M) {return 0.05;}


sources defaultSources()
{
    sources s;
    s = setSources(fescDef, NionDef, fstarSteveEnergy, fxDef, minMassDef);
    return s;
}

// Jordan Nion = 3622
// Jordan Nlw = 12126


   

#endif
